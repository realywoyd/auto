import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
import json

# Включение логирования
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logger = logging.getLogger(__name__)

# Токен вашего бота (храните его в безопасном месте, например, в переменной окружения)
BOT_TOKEN = "7573441680:AAHHSGux7S4nYmc86Y3fG-JdOofmm7Uoa1E"

# Обработчик команды /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    keyboard = [
        [InlineKeyboardButton("Открыть магазин", web_app={"url": "YOUR_WEB_APP_URL"})]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(
        "Добро пожаловать в АвтоСтиль! Откройте наш магазин автоаксессуаров:",
        reply_markup=reply_markup
    )

# Обработчик данных от Web App
async def web_app_data(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    data = json.loads(update.message.web_app_data.data)
    if data["type"] == "order":
        items = data["items"]
        total = data["total"]
        response = f"Ваш заказ:\n"
        for item in items:
            response += f"- {item['name']} (x{item['quantity']}): {item['price']} ₽\n"
        response += f"\nИтого: {total} ₽\nСпасибо за заказ!"
        await update.message.reply_text(response)

# Обработчик ошибок
async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    logger.error(f"Update {update} caused error {context.error}")

def main() -> None:
    # Создаем приложение
    application = Application.builder().token(BOT_TOKEN).build()

    # Регистрируем обработчики
    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.StatusUpdate.WEB_APP_DATA, web_app_data))
    application.add_error_handler(error_handler)

    # Запускаем бота
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    main()
